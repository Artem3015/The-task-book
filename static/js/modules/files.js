export async function initializeFiles() {
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸
    document.addEventListener('DOMContentLoaded', () => {
        setupFileEventListeners();
    });
}

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
function setupFileEventListeners() {
    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
    document.getElementById('uploadFileBtn')?.addEventListener('click', uploadFiles);
    document.getElementById('taskFileInput')?.addEventListener('change', handleFileInputChange);
    
    // Drag and drop Ğ´Ğ»Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
    const dropZone = document.getElementById('fileDropZone');
    if (dropZone) {
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);
    }
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
export async function updateTaskFilesList(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/files`);
        if (!response.ok) throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²');

        const files = await response.json();
        console.log('ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸', taskId, ':', files);
        renderFilesList(files, taskId);
    } catch (error) {
        console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²:', error);
        renderFilesError();
    }
}

// ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
function renderFilesList(files, taskId) {
    const filesList = document.getElementById('editTaskFiles');
    if (!filesList) {
        console.warn('Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ editTaskFiles Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
        return;
    }

    filesList.innerHTML = files.map(file => `
        <div class="file-item" data-fileid="${file.id}">
            <div class="file-info">
                <a href="/api/tasks/${taskId}/files/${file.id}" 
                   target="_blank" 
                   class="file-link">
                    <span class="file-icon">${getFileIcon(file.name)}</span>
                    <span class="file-name">${file.name}</span>
                </a>
                <span class="file-size">${formatFileSize(file.size)}</span>
            </div>
            <button class="delete-file" data-fileid="${file.id}">
                âœ•
            </button>
        </div>
    `).join('');

    // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
    document.querySelectorAll('.delete-file').forEach(btn => {
        btn.addEventListener('click', (e) => deleteFile(e, taskId));
    });
}

// ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
function renderFilesError() {
    const filesList = document.getElementById('editTaskFiles');
    if (filesList) {
        filesList.innerHTML = '<div class="file-error">ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²</div>';
    }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
async function uploadFiles() {
    if (!window.currentEditId) return;

    const fileInput = document.getElementById('taskFileInput');
    if (!fileInput.files.length) {
        alert('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸');
        return;
    }

    const formData = new FormData();
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('files', fileInput.files[i]);
    }

    try {
        const response = await fetch(`/api/tasks/${window.currentEditId}/files`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²');

        fileInput.value = '';
        await updateTaskFilesList(window.currentEditId);
    } catch (error) {
        console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²:', error);
        alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹');
    }
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°
async function deleteFile(event, taskId) {
    const fileId = event.target.dataset.fileid;
    if (!confirm('Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ»?')) return;

    try {
        const response = await fetch(`/api/tasks/${taskId}/files/${fileId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°');

        await updateTaskFilesList(taskId);
    } catch (error) {
        console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°:', error);
        alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»');
    }
}

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
function handleFileInputChange(e) {
    const files = e.target.files;
    const fileInfo = document.getElementById('fileInfo');
    
    if (!files.length) {
        fileInfo.textContent = '';
        return;
    }

    const names = Array.from(files).map(f => f.name).join(', ');
    fileInfo.textContent = `Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: ${files.length} (${names})`;
}

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° drag and drop
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    e.target.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    e.target.classList.remove('drag-over');

    const files = e.dataTransfer.files;
    if (!files.length) return;

    const fileInput = document.getElementById('taskFileInput');
    fileInput.files = files;
    handleFileInputChange({ target: fileInput });
}

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸

function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    const icons = {
        pdf: 'ğŸ“„',
        doc: 'ğŸ“',
        docx: 'ğŸ“',
        xls: 'ğŸ“Š',
        xlsx: 'ğŸ“Š',
        ppt: 'ğŸ“‘',
        pptx: 'ğŸ“‘',
        jpg: 'ğŸ–¼ï¸',
        jpeg: 'ğŸ–¼ï¸',
        png: 'ğŸ–¼ï¸',
        gif: 'ğŸ–¼ï¸',
        txt: 'ğŸ“‹',
        zip: 'ğŸ—„ï¸',
        rar: 'ğŸ—„ï¸',
        mp3: 'ğŸµ',
        mp4: 'ğŸ¬'
    };
    return icons[extension] || 'ğŸ“';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¼Ğ¾Ğ´ÑƒĞ»ÑÑ…
export async function handleTaskFiles(taskId) {
    return updateTaskFilesList(taskId);
}